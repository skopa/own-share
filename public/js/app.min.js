var Viewer=function(e){var t=this;this.service=$("#service"),this.files=$("#list-container");var i=this.template=function(e,t){var i=$("#"+e).html();if(t){var n=function(e,t){$.each(e,function(e,s){if("object"==typeof s&&null!==s)return n(s,t+e+".");i=i.replace(new RegExp("{{"+t+e+"}}","g"),s)})};n(t,"")}return i};this.home=function(){return e.user?t.profile():t.login()},this.profile=function(){t.service.html(i("profile-tpl",e.user)),t.service.find(">div").animate({height:"show"},200),e.listeners()},this.login=function(){t.service.html(i("login-tpl")),t.service.find(">div").animate({height:"show"},200),e.listeners()},this.registration=function(){t.service.html(i("registration-tpl")),t.service.find(">div").animate({height:"show"},200),e.listeners()},this.error=function(e){console.error(e),$("#modal-container").html(i("modal-tpl",{text:"test"})),$("#modal-container .modal-body").addClass("opened"),$("#modal-container .modal-body").addClass("success"),$("#modal-container .close").click(function(){$("#modal-container .modal-body").removeClass("opened")})},this.file=function(n){n.control=e.canControl(n)?"":"hide",t.files.prepend(i("list-item-tpl",n)),e.listeners()},this.deleteFile=function(e){t.files.find("[data-id="+e+"]").remove()},this.details=function(n,s){n.control=e.canControl(n)?"":"hide",n.access=e.fileAccess(n),t.service.html(i("detail-tpl",n)),s?t.service.find(">div").show():t.service.find(">div").animate({height:"show"},200),console.info(n),e.listeners()}},app=new function(){var e=this,t=new Viewer(e);e.user={},this.init=function(){e.http(),e.auth(),e.upload(),e.link()},this.canControl=function(t){return!!e.user&&(t.user_id===e.user.id||1===e.user.is_admin)},this.fileAccess=function(e){return{public:e.is_public&&!e.is_private?"active":"",private:!e.is_public&&e.is_private?"active":"",registered:e.is_public&&e.is_private?"active":""}},this.http=function(){$.ajaxSetup({beforeSend:function(e){e.setRequestHeader("Api-Token",localStorage.getItem("Api-Token")),e.setRequestHeader("Accept","application/json")}})},this.auth=function(){$.ajax({method:"GET",url:"/api/profile",success:function(i){e.user=i.data,t.profile()},error:function(){e.user=void 0,t.login()},complete:app.files})},this.upload=function(){var e=$("#upload");e.fileupload({dropZone:e.find("#drop"),add:function(e,i){var n=$(t.template("upload-li-tpl",{size:function(e){if("number"!=typeof e)return"";if(e>=1073741824)return(e/1073741824).toFixed(2)+" GB";if(e>=1048576)return(e/1048576).toFixed(2)+" MB";return(e/1024).toFixed(2)+" KB"}(i.files[0].size),name:i.files[0].name}));i.context=n.appendTo($("#upload-list")),n.find("input").knob(),n.find("span").click(function(){n.hasClass("working")&&s.abort(),n.fadeOut(function(){n.remove()})});var s=i.submit()},progress:function(e,t){var i=(t.loaded/t.total*100).toFixed(2);t.context.find("input").val(i).change()},fail:function(e,t){t.context.addClass("error")},done:function(e,i){i.context.removeClass("working"),t.file(i.result.data)}}),$(document).on("drop dragover",function(e){e.preventDefault()})},this.link=function(){$("#share").submit(function(e){e.preventDefault();$.ajax({method:"POST",url:this.action,data:{link:this.link.value},success:function(e){document.getElementById("share").reset(),t.file(e.data)}})})},this.files=function(){$.ajax({method:"GET",url:"/api/resources",success:function(e){$("#list-container").html(""),e.data.forEach(t.file)}})},this.logout=function(){localStorage.removeItem("Api-Token"),e.user=void 0,e.http(),e.files(),t.login()},this.listeners=function(){var e=$("#login");e.find("form").off().submit(function(e){e.preventDefault(),$.ajax({method:"POST",url:"/api/login",data:{username:this.elements.username.value,password:this.elements.password.value},success:function(e){localStorage.setItem("Api-Token",e.api_token),app.http(),app.auth()},error:function(e){alert(e)}})}),e.find("[rel='registration']").off().click(function(){t.registration()}),$("#profile").find("[rel='logout']").off().click(function(){app.logout()});var i=$("#registration");i.find("form").off().submit(function(e){e.preventDefault(),$.ajax({method:"POST",url:"/api/registration",data:{email:this.elements.email.value,username:this.elements.username.value,password:this.elements.password.value,password_confirmation:this.elements.password.value},success:function(e){console.info(e),alert("successfully"),t.login()},error:function(e){alert(e)}})}),i.find("[rel='login']").off().click(function(){t.login()}),$(".item").off().click(function(){this.classList.contains("selected")?(this.classList.remove("selected"),t.home()):(t.files.find(".item").removeClass("selected"),this.classList.add("selected"),$.ajax({method:"GET",url:"/api/resources/"+this.dataset.id,success:function(e){t.details(e.data)}}))});var n=$("#detail");n.find("[rel='back']").off().click(function(){t.files.find(".list-item").removeClass("selected"),t.home()}),n.find("[rel='update']").off().click(function(){$.ajax({method:"PUT",data:this.dataset,url:"/api/resources/"+this.parentElement.dataset.id,success:function(e){t.details(e.data,!0)}})}),n.find("[rel='delete']").off().click(function(){var e=this.parentElement.dataset.id;$.ajax({method:"DELETE",url:"/api/resources/"+e,success:function(){t.deleteFile(e),t.home()}})})}};$(document).ready(app.init);